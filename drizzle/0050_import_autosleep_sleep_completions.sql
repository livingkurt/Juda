-- Import AutoSleep daily sleep completions into the sleep task.
-- Duration uses AutoSleep's "asleep" value (awake time already excluded),
-- so we intentionally do NOT derive duration from sleepStart/sleepEnd.

WITH sleep_task AS (
  SELECT id
  FROM "Task"
  WHERE "completionType" = 'sleep'
  ORDER BY "createdAt" DESC
  LIMIT 1
),
import_rows("date", "sleepStart", "sleepEnd", "durationMinutes") AS (
  VALUES
    ('2026-01-01', '2025-12-31T23:45:00Z', '2026-01-01T08:03:00Z', 498),
    ('2026-01-02', '2026-01-02T00:45:00Z', '2026-01-02T09:33:00Z', 297),
    ('2026-01-03', '2026-01-02T23:46:00Z', '2026-01-03T07:51:00Z', 456),
    ('2026-01-04', '2026-01-03T23:58:00Z', '2026-01-04T10:33:00Z', 624),
    ('2026-01-05', '2026-01-05T01:14:00Z', '2026-01-05T08:18:00Z', 424),
    ('2026-01-06', '2026-01-06T01:15:00Z', '2026-01-06T07:42:00Z', 387),
    ('2026-01-07', '2026-01-07T00:07:00Z', '2026-01-07T07:37:00Z', 450),
    ('2026-01-08', '2026-01-07T23:56:00Z', '2026-01-08T08:00:00Z', 483),
    ('2026-01-09', '2026-01-09T00:00:00Z', '2026-01-09T05:01:00Z', 301),
    ('2026-01-10', '2026-01-10T00:26:00Z', '2026-01-10T09:07:00Z', 509),
    ('2026-01-11', '2026-01-11T00:30:00Z', '2026-01-11T09:46:00Z', 556),
    ('2026-01-12', '2026-01-12T00:15:00Z', '2026-01-12T08:13:00Z', 478),
    ('2026-01-13', '2026-01-12T23:54:00Z', '2026-01-13T08:05:00Z', 517),
    ('2026-01-14', '2026-01-13T23:27:00Z', '2026-01-14T07:41:00Z', 494),
    ('2026-01-15', '2026-01-15T00:37:00Z', '2026-01-15T07:56:00Z', 439),
    ('2026-01-16', '2026-01-16T00:24:00Z', '2026-01-16T08:00:00Z', 456),
    ('2026-01-17', '2026-01-17T01:30:00Z', '2026-01-17T10:16:00Z', 526),
    ('2026-01-18', '2026-01-18T01:26:00Z', '2026-01-18T08:58:00Z', 452),
    ('2026-01-19', '2026-01-19T00:00:00Z', '2026-01-19T08:21:00Z', 500),
    ('2026-01-20', '2026-01-20T00:00:00Z', '2026-01-20T07:58:00Z', 473),
    ('2026-01-21', '2026-01-21T00:30:00Z', '2026-01-21T08:21:00Z', 471),
    ('2026-01-22', '2026-01-22T00:04:00Z', '2026-01-22T07:30:00Z', 446),
    ('2026-01-23', '2026-01-23T00:27:00Z', '2026-01-23T07:49:00Z', 431),
    ('2026-01-24', '2026-01-24T00:37:00Z', '2026-01-24T07:39:00Z', 422),
    ('2026-01-25', '2026-01-24T23:59:00Z', '2026-01-25T07:49:00Z', 470),
    ('2026-01-26', '2026-01-25T23:44:00Z', '2026-01-26T07:41:00Z', 477),
    ('2026-01-27', '2026-01-27T00:38:00Z', '2026-01-27T07:48:00Z', 430),
    ('2026-01-28', '2026-01-27T23:57:00Z', '2026-01-28T07:49:00Z', 472),
    ('2026-01-29', '2026-01-29T00:29:00Z', '2026-01-29T07:14:00Z', 405),
    ('2026-01-30', '2026-01-30T00:37:00Z', '2026-01-30T07:12:00Z', 395),
    ('2026-01-31', '2026-01-30T22:31:00Z', '2026-01-31T11:34:00Z', 600),
    ('2026-02-01', '2026-02-01T08:14:00Z', '2026-02-01T12:45:00Z', 164),
    ('2026-02-02', '2026-02-02T03:15:00Z', '2026-02-02T07:00:00Z', 137),
    ('2026-02-03', '2026-02-02T20:45:00Z', '2026-02-03T11:56:00Z', 762),
    ('2026-02-04', '2026-02-04T00:03:00Z', '2026-02-04T09:58:00Z', 595),
    ('2026-02-05', '2026-02-04T23:52:00Z', '2026-02-05T08:09:00Z', 442),
    ('2026-02-06', '2026-02-06T00:41:00Z', '2026-02-06T09:33:00Z', 522),
    ('2026-02-07', '2026-02-07T01:11:00Z', '2026-02-07T10:04:00Z', 500),
    ('2026-02-08', '2026-02-08T01:45:00Z', '2026-02-08T09:45:00Z', 480),
    ('2026-02-09', '2026-02-08T23:39:00Z', '2026-02-09T08:04:00Z', 500),
    ('2026-02-10', '2026-02-09T23:59:00Z', '2026-02-10T07:53:00Z', 474),
    ('2026-02-11', '2026-02-11T00:07:00Z', '2026-02-11T07:53:00Z', 466),
    ('2026-02-12', '2026-02-11T23:37:00Z', '2026-02-12T08:01:00Z', 504),
    ('2026-02-13', '2026-02-12T23:24:00Z', '2026-02-13T04:06:00Z', 270),
    ('2026-02-14', '2026-02-14T00:27:00Z', '2026-02-14T08:56:00Z', 509),
    ('2026-02-15', '2026-02-15T01:28:00Z', '2026-02-15T10:15:00Z', 468),
    ('2026-02-16', '2026-02-16T00:30:00Z', '2026-02-16T09:31:00Z', 541),
    ('2026-02-17', '2026-02-16T23:49:00Z', '2026-02-17T08:08:00Z', 499),
    ('2026-02-18', '2026-02-17T23:12:00Z', '2026-02-18T08:05:00Z', 533),
    ('2026-02-19', '2026-02-19T00:24:00Z', '2026-02-19T07:21:00Z', 417),
    ('2026-02-20', '2026-02-19T23:30:00Z', '2026-02-20T09:08:00Z', 546),
    ('2026-02-21', '2026-02-21T00:30:00Z', '2026-02-21T09:27:00Z', 537),
    ('2026-02-22', '2026-02-22T01:04:00Z', '2026-02-22T09:21:00Z', 497)
)
INSERT INTO "TaskCompletion" ("id", "taskId", "date", "outcome", "selectedOptions", "completedAt")
SELECT
  ('c' || floor(extract(epoch FROM clock_timestamp()) * 1000)::bigint::text || substr(md5(ir."date"), 1, 8)),
  st.id,
  ir."date"::timestamp,
  'completed',
  jsonb_build_object(
    'sleepStart',
    ir."sleepStart",
    'sleepEnd',
    ir."sleepEnd",
    'durationMinutes',
    ir."durationMinutes",
    'source',
    'autosleep_csv'
  ),
  now()
FROM import_rows ir
CROSS JOIN sleep_task st
ON CONFLICT ("taskId", "date")
DO UPDATE SET
  "outcome" = EXCLUDED."outcome",
  "selectedOptions" = EXCLUDED."selectedOptions",
  "completedAt" = EXCLUDED."completedAt";