---
alwaysApply: true
---

# Drizzle ORM Migration Rules for Juda Project

## Overview

This project uses **Drizzle ORM** with Neon PostgreSQL. Migrations work like **Rails migrations** - fully automated with no manual file creation.

## ⚠️ CRITICAL: The One Command You Need

```bash
npm run db:generate migration_name
```

This **automatically creates everything**:

- ✅ `drizzle/000X_migration_name.sql` - Empty SQL file for you to fill in
- ✅ `drizzle/meta/000X_snapshot.json` - Schema snapshot (auto-generated)
- ✅ Updates `drizzle/meta/_journal.json` - Migration tracking (auto-updated)

**You only write the SQL. Everything else is automatic.**

## Standard Workflow

### Step 1: Generate the migration

```bash
npm run db:generate add_priority_field
```

### Step 2: Write your SQL

Edit the generated file `drizzle/000X_add_priority_field.sql`:

```sql
-- Add priority column to Task table
ALTER TABLE "Task" ADD COLUMN "priority" integer DEFAULT 0 NOT NULL;
```

### Step 3: Test locally

```bash
npm run db:migrate
```

### Step 4: Commit and deploy

```bash
git add .
git commit -m "Add priority field to tasks"
git push
```

**Done!** Vercel automatically runs `drizzle-kit migrate` during build.

## Commands Reference

| Command                              | What It Does                                       |
| ------------------------------------ | -------------------------------------------------- |
| `npm run db:generate migration_name` | Creates empty migration + snapshot + journal entry |
| `npm run db:migrate`                 | Applies pending migrations to database             |
| `npm run db:studio`                  | Opens database browser                             |
| `npm run db:push`                    | ❌ DANGEROUS - Never use in production             |

## How It Works Under the Hood

The `scripts/generate-migration.js` script uses Drizzle's `--custom` flag:

```javascript
execSync(`npx drizzle-kit generate --name=${migrationName} --custom`);
```

This bypasses all interactive prompts and generates all required files automatically.

## ❌ NEVER Do These

1. **Never manually create migration files** - Use `npm run db:generate`
2. **Never manually edit `_journal.json`** - Auto-managed by Drizzle
3. **Never manually create snapshot files** - Auto-generated by `--custom`
4. **Never use `drizzle-kit push` in production** - Deletes data!
5. **Never skip migrations** - Always generate and commit them

## ✅ ALWAYS Do These

1. **Use `npm run db:generate migration_name`** for new migrations
2. **Write SQL with `IF NOT EXISTS` / `IF EXISTS`** for safety
3. **Add defaults to NOT NULL columns** on tables with existing data
4. **Test locally with `npm run db:migrate`** before pushing
5. **Commit ALL migration files** (SQL + meta/) to git

## Migration File Structure

After running `npm run db:generate my_migration`:

```
drizzle/
├── 0000_silent_mandroid.sql      # Existing
├── 0001_add_parent_id.sql        # Existing
├── 0002_migrate_subtasks.sql     # Existing
├── 0003_my_migration.sql         # ← NEW (empty, you fill it in)
└── meta/
    ├── _journal.json             # ← AUTO-UPDATED
    ├── 0000_snapshot.json        # Existing
    ├── 0001_snapshot.json        # Existing
    ├── 0002_snapshot.json        # Existing
    └── 0003_snapshot.json        # ← AUTO-GENERATED
```

## Example: Adding a Field

**User asks:** "Add a 'priority' field to Task"

```bash
# 1. Generate migration
npm run db:generate add_task_priority

# 2. Edit the generated SQL file
cat > drizzle/0003_add_task_priority.sql << 'EOF'
ALTER TABLE "Task" ADD COLUMN "priority" integer DEFAULT 0 NOT NULL;
EOF

# 3. Test locally
npm run db:migrate

# 4. Commit and push
git add .
git commit -m "Add priority field to tasks"
git push
```

## Example: Complex Data Migration

```bash
# 1. Generate migration
npm run db:generate migrate_user_data

# 2. Edit with complex SQL
```

```sql
-- drizzle/0003_migrate_user_data.sql
DO $$
DECLARE
    row RECORD;
BEGIN
    FOR row IN SELECT * FROM "OldTable" LOOP
        INSERT INTO "NewTable" (id, data) VALUES (row.id, row.data);
    END LOOP;
END $$;

ALTER TABLE "OldTable" DROP COLUMN IF EXISTS "deprecated_field";
```

## Deployment Flow

```
Local Development          →    Git Push    →    Vercel Build
─────────────────────────────────────────────────────────────
1. npm run db:generate     →    git push    →    drizzle-kit migrate
2. Write SQL                                     (runs automatically)
3. npm run db:migrate                            next build
4. git add & commit                              Deploy! ✅
```

## Troubleshooting

### "Column already exists" error

Migration already ran. Drizzle skips applied migrations automatically. This is safe.

### Migration fails on Vercel

1. Check build logs for error
2. Fix the SQL in the migration file
3. Commit and push the fix

### Need to undo a migration

Create a NEW migration that reverses it:

```bash
npm run db:generate revert_priority_field
# Then write SQL to drop the column
```

## Key Reminders

| Do This                         | Not This                        |
| ------------------------------- | ------------------------------- |
| `npm run db:generate name`      | Manually create SQL files       |
| Let `--custom` create snapshots | Manually create snapshot files  |
| Let Drizzle update journal      | Manually edit `_journal.json`   |
| `npm run db:migrate`            | `npm run db:push` in production |
| Commit everything in `drizzle/` | Ignore migration files          |
