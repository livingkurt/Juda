---
alwaysApply: true
---

# Juda - Daily Task Manager

## üö® CRITICAL REMINDERS (Always Apply)

Before making any changes, remember:

1. **React 19** - Don't use `useMemo`/`useCallback` unless there's high computational cost
2. **Chakra UI v3** - Syntax is different from v2, check existing components for patterns
3. **Next.js 16** - Latest version with App Router
4. **Drizzle ORM** - NOT Prisma! Use `lib/db.js` and `lib/schema.js`
5. **Lint-Free** - Always run `npm run lint` and fix ALL errors before completing tasks

---

## Project Overview

Juda is a daily task management system built with Next.js, Chakra UI, and PostgreSQL. The core feature is a flexible drag-and-drop interface that allows users to seamlessly move tasks between three main areas:

1. **Backlog** - Unscheduled tasks without dates/times
2. **Today View** - Tasks organized by sections (Morning, Afternoon, Evening)
3. **Calendar** - Day/Week/Month views with time-based scheduling

The goal is to make task scheduling feel effortless - drag a task from your backlog to the calendar to schedule it, or drag it back to unschedule it.

---

## Tech Stack

- **Framework**: Next.js 16 (App Router) - Latest version
- **React**: React 19 - Latest version with automatic optimizations
- **UI Library**: Chakra UI v3 - Latest version (syntax differs significantly from v2)
- **Database**: PostgreSQL with Drizzle ORM (NOT Prisma)
- **Drag & Drop**: @hello-pangea/dnd
- **Icons**: Lucide React

---

## ‚ö†Ô∏è CRITICAL: React 19 Optimization Rules

**React 19 automatically optimizes components**, so `useMemo` and `useCallback` are **NOT necessary** unless you have:

1. **High computational cost** - Expensive calculations that take >10ms
2. **Large object/array creation** - Creating massive data structures (>1000 items)
3. **Stable reference requirements** - When a dependency array requires exact reference equality

### ‚ùå DON'T Do This (Unnecessary in React 19)

```javascript
// Bad - React 19 handles this automatically
const memoizedValue = useMemo(() => expensiveCalculation(data), [data]);
const memoizedCallback = useCallback(() => handleClick(id), [id]);
```

### ‚úÖ DO This Instead

```javascript
// Good - Let React 19 optimize automatically
const value = expensiveCalculation(data);
const handleClick = () => doSomething(id);
```

**Only use useMemo/useCallback when profiling shows actual performance issues.**

---

## ‚ö†Ô∏è CRITICAL: Chakra UI v3 Syntax

**Chakra UI v3 has significant syntax differences from v2.** Always use v3 patterns:

### Component Imports

```javascript
// ‚úÖ CORRECT - v3 syntax
import { Box, Flex, Button, Text, VStack, HStack } from "@chakra-ui/react";
```

### Styling Patterns

Chakra UI v3 uses a different styling system. Check existing components for patterns:

- Use `Box`, `Flex`, `VStack`, `HStack` for layout
- Use `Button`, `Text`, `Input` for form elements
- Check `components/TaskItem.jsx` and `components/WorkoutModal.jsx` for examples

**When in doubt, check existing components in the codebase for v3 patterns.**

---

## ‚ö†Ô∏è CRITICAL: Lint-Free Codebase

**This project maintains a lint-free codebase.** You MUST:

1. **Run linters after every code change:**

   ```bash
   npm run lint
   ```

2. **Fix ALL linting errors before completing any task:**

   ```bash
   npm run lint:fix  # Auto-fix what can be fixed
   # Then manually fix remaining issues
   ```

3. **Never commit code with linting errors**

4. **Check linting status before marking tasks complete**

The project uses ESLint with Next.js, React, and Prettier configurations. All code must pass linting checks.

---

## Project Structure

```text
juda/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ api/                    # API routes
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tasks/             # Task CRUD + reorder
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sections/          # Section CRUD + reorder
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ backlog/           # Backlog item CRUD
‚îÇ   ‚îú‚îÄ‚îÄ layout.jsx             # Root layout
‚îÇ   ‚îú‚îÄ‚îÄ page.jsx               # Main app (drag context lives here)
‚îÇ   ‚îî‚îÄ‚îÄ providers.jsx          # Chakra provider
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ Section.jsx            # Today view sections container
‚îÇ   ‚îú‚îÄ‚îÄ TaskItem.jsx           # Individual task card
‚îÇ   ‚îú‚îÄ‚îÄ TaskDialog.jsx         # Create/edit task modal
‚îÇ   ‚îú‚îÄ‚îÄ SectionDialog.jsx      # Create/edit section modal
‚îÇ   ‚îú‚îÄ‚îÄ BacklogDrawer.jsx      # Backlog sidebar
‚îÇ   ‚îú‚îÄ‚îÄ CalendarDayView.jsx    # Day calendar view
‚îÇ   ‚îú‚îÄ‚îÄ CalendarWeekView.jsx   # Week calendar view
‚îÇ   ‚îî‚îÄ‚îÄ CalendarMonthView.jsx  # Month calendar view
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îú‚îÄ‚îÄ useTasks.js            # Task state & API calls
‚îÇ   ‚îú‚îÄ‚îÄ useSections.js         # Section state & API calls
‚îÇ   ‚îî‚îÄ‚îÄ useBacklog.js          # Backlog state & API calls
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îú‚îÄ‚îÄ db.js                  # Drizzle database client
‚îÇ   ‚îú‚îÄ‚îÄ schema.js              # Drizzle schema definitions
‚îÇ   ‚îú‚îÄ‚îÄ utils.js               # Helper functions
‚îÇ   ‚îî‚îÄ‚îÄ constants.js           # App constants
‚îî‚îÄ‚îÄ drizzle/
    ‚îú‚îÄ‚îÄ *.sql                  # Migration SQL files
    ‚îî‚îÄ‚îÄ meta/                  # Migration metadata
```

---

## Drag & Drop System Architecture

### The Golden Rule: Droppable IDs

**CRITICAL**: All droppable IDs use a pipe (`|`) separator, NOT colons (`:`).

This is because ISO date strings contain colons (e.g., `2025-01-15T00:00:00.000Z`), which would break string splitting.

```javascript
// ‚úÖ CORRECT - use pipe separator
"calendar-day|2025-01-15T00:00:00.000Z";
"today-section|cuid123abc";

// ‚ùå WRONG - colons conflict with ISO dates
"calendar-day:2025-01-15T00:00:00.000Z";
```

### Droppable ID Format

The `createDroppableId` helper in `page.jsx` generates consistent IDs:

```javascript
createDroppableId = {
  backlog: () => "backlog",
  todaySection: sectionId => `today-section|${sectionId}`,
  calendarDay: date => `calendar-day|${date.toISOString()}`,
  calendarDayUntimed: date => `calendar-day-untimed|${date.toISOString()}`,
  calendarWeek: date => `calendar-week|${date.toISOString()}`,
  calendarWeekUntimed: date => `calendar-week-untimed|${date.toISOString()}`,
};
```

### Parsing Droppable IDs

The `parseDroppableId` function in `page.jsx` extracts structured data:

```javascript
parseDroppableId("backlog");
// ‚Üí { type: "backlog" }

parseDroppableId("today-section|abc123");
// ‚Üí { type: "today-section", sectionId: "abc123" }

parseDroppableId("calendar-day|2025-01-15T00:00:00.000Z");
// ‚Üí { type: "calendar", view: "day", isUntimed: false, date: Date }

parseDroppableId("calendar-week-untimed|2025-01-15T00:00:00.000Z");
// ‚Üí { type: "calendar", view: "week", isUntimed: true, date: Date }
```

---

## Drag Behavior Matrix

| From     | To                 | Result                              |
| -------- | ------------------ | ----------------------------------- |
| Backlog  | Today Section      | Sets date to today, clears time     |
| Backlog  | Calendar (timed)   | Sets date + time from drop position |
| Backlog  | Calendar (untimed) | Sets date, no time                  |
| Today    | Calendar (timed)   | Sets time from drop position        |
| Today    | Calendar (untimed) | Clears time, keeps date             |
| Today    | Backlog            | Clears date + time                  |
| Calendar | Today Section      | Clears time, sets date to today     |
| Calendar | Backlog            | Clears date + time                  |
| Calendar | Calendar           | Updates date/time based on position |

---

## Two Drag Systems (Important!)

The calendar views use TWO separate drag systems:

### 1. @hello-pangea/dnd (Cross-Container)

- Handles dragging tasks between containers (backlog ‚Üî today ‚Üî calendar)
- Uses `<DragDropContext>`, `<Droppable>`, `<Draggable>` from `@hello-pangea/dnd`
- Controlled by `handleDragEnd` in `TasksTab.jsx` and `KanbanTab.jsx`

### 2. Internal Mouse Drag (Time/Duration Adjustment)

- Handles dragging tasks vertically within the calendar to change time
- Handles resizing tasks by dragging the bottom edge
- Uses `useState` + `onMouseDown/Move/Up` events
- Lives inside `CalendarDayView.jsx` and `CalendarWeekView.jsx`

**Why two systems?** The DnD library doesn't support free-form positioning needed for time adjustment. The internal system provides pixel-perfect time snapping.

```javascript
// Internal drag state in calendar views
const [internalDrag, setInternalDrag] = useState({
  taskId: null,
  type: null, // "move" or "resize"
  startY: 0,
  startMinutes: 0,
  currentMinutes: 0,
  // ...
});
```

---

## Task Recurrence Model

Tasks use a `recurrence` JSON field to determine when they appear:

```javascript
// One-time task (shows only on specific date)
recurrence: {
  type: "none",
  startDate: "2025-01-15T00:00:00.000Z"
}

// Daily recurring task
recurrence: {
  type: "daily",
  startDate: "2025-01-01T00:00:00.000Z"  // optional start date
}

// Weekly recurring task (specific days)
recurrence: {
  type: "weekly",
  days: [1, 3, 5],  // Mon, Wed, Fri (0=Sun, 6=Sat)
  startDate: "2025-01-01T00:00:00.000Z"
}

// No recurrence (task appears in backlog only)
recurrence: null
```

The `shouldShowOnDate(task, date)` function in `lib/utils.js` determines visibility.

---

## State Management Pattern

All state flows through custom hooks with optimistic updates:

```javascript
// Example from useTasks.js
const updateTask = async (id, taskData) => {
  const previousTasks = [...tasks];

  // Optimistic update
  setTasks(prev => prev.map(t => t.id === id ? { ...t, ...taskData } : t));

  try {
    const response = await fetch("/api/tasks", { ... });
    const updatedTask = await response.json();
    setTasks(prev => prev.map(t => t.id === id ? updatedTask : t));
  } catch (err) {
    // Rollback on error
    setTasks(previousTasks);
    throw err;
  }
};
```

---

## Key Files to Understand

1. **`app/page.jsx`** - Main component with DragDropContext, handleDragEnd logic, and state coordination
2. **`components/CalendarDayView.jsx`** - Day view with both DnD and internal drag systems
3. **`lib/utils.js`** - `shouldShowOnDate()`, `calculateTaskPositions()`, time conversion helpers
4. **`hooks/useTasks.js`** - Task CRUD with optimistic updates
5. **`lib/db.js`** - Drizzle database client and connection
6. **`lib/schema.js`** - Drizzle schema definitions

---

## Common Pitfalls

### ‚ùå Don't use colons in droppable IDs

```javascript
// Bad - will break parsing
droppableId={`calendar:${date.toISOString()}`}

// Good - use pipe separator
droppableId={createDroppableId.calendarDay(date)}
```

### ‚ùå Don't forget to pass createDroppableId to components

```jsx
// Components need this to generate consistent IDs
<CalendarDayView createDroppableId={createDroppableId} ... />
```

### ‚ùå Don't mix up the two drag systems

```javascript
// Internal drag is for time adjustment WITHIN calendar
// DnD drag is for moving BETWEEN containers
// They should not interfere with each other
```

### ‚ùå Don't forget optimistic updates need rollback

```javascript
// Always store previous state before optimistic update
const previousTasks = [...tasks];
setTasks(newTasks);
try {
  await api();
} catch {
  setTasks(previousTasks);
}
```

---

## Adding New Features

### Adding a new droppable area

1. Add ID generator to `createDroppableId` in `page.jsx`
2. Add parsing logic to `parseDroppableId` in `page.jsx`
3. Add behavior rules to `handleDragEnd` in `page.jsx`
4. Create the `<Droppable>` component with correct ID

### Adding a new task property

1. Update Drizzle schema in `lib/schema.js`
2. Generate migration: `npm run db:generate migration_name`
3. Write SQL in the generated migration file
4. Run migration: `npm run db:migrate`
5. Update API routes to handle the field
6. Update `TaskDialog.jsx` form
7. Update display in `TaskItem.jsx` / calendar views

---

## Development Commands

```bash
npm run dev          # Start dev server on port 3001
npm run build        # Build for production
npm run lint         # Check for linting errors
npm run lint:fix     # Auto-fix linting errors
npm run db:generate <name>  # Generate Drizzle migration
npm run db:migrate   # Apply pending migrations
npm run db:studio    # Open database GUI (Drizzle Studio)
```

---

## Testing Drag & Drop

When testing drag functionality, verify:

1. ‚úÖ Task appears in correct location after drop
2. ‚úÖ Task's `time` and `recurrence` fields updated correctly
3. ‚úÖ UI updates immediately (optimistic update works)
4. ‚úÖ Refresh shows persisted state
5. ‚úÖ Calendar time adjustment works independently
6. ‚úÖ Resize handle adjusts duration correctly
