# ============================================
# Coolify "This Machine" Fix Commands
# ============================================
#
# IMPORTANT: Run these commands ON YOUR UNRAID SERVER
#
# Step 1: SSH into Unraid
#   ssh root@192.168.1.133
#
# Step 2: Copy and paste ALL the commands below
# ============================================

echo "ðŸ”§ Starting Coolify Fix..."

# Create .ssh directory if it doesn't exist
mkdir -p /root/.ssh
chmod 700 /root/.ssh

# Generate SSH key pair
ssh-keygen -t ed25519 -f /root/.ssh/coolify_localhost -N "" -C "coolify-localhost"

# Add public key to authorized_keys
cat /root/.ssh/coolify_localhost.pub >> /root/.ssh/authorized_keys
chmod 600 /root/.ssh/authorized_keys

# Test SSH connection
echo "Testing SSH connection..."
ssh -i /root/.ssh/coolify_localhost -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@localhost "echo 'SSH works!'" 2>/dev/null

# Read the private key
PRIVATE_KEY=$(cat /root/.ssh/coolify_localhost)

# Clean up existing entries
echo "Cleaning up database..."
docker exec -i coolify-db psql -U coolify -d coolify << 'EOF'
DELETE FROM servers WHERE id = 0;
DELETE FROM private_keys WHERE id = 0;
EOF

# Insert private key
echo "Inserting private key..."
docker exec -i coolify-db psql -U coolify -d coolify << EOF
INSERT INTO private_keys (id, uuid, name, description, private_key, team_id, created_at, updated_at)
VALUES (0, gen_random_uuid(), 'localhost-key', 'SSH key for localhost', '$PRIVATE_KEY', 0, NOW(), NOW());
EOF

# Insert server entry
echo "Inserting server entry..."
docker exec -i coolify-db psql -U coolify -d coolify << 'EOF'
INSERT INTO servers (id, uuid, name, description, ip, port, "user", team_id, private_key_id, created_at, updated_at)
VALUES (0, gen_random_uuid(), 'localhost', 'This server', 'host.docker.internal', 22, 'root', 0, 0, NOW(), NOW());
EOF

# Verify entries
echo "Verifying database entries..."
docker exec -i coolify-db psql -U coolify -d coolify << 'EOF'
SELECT id, name, ip, port, "user" FROM servers WHERE id = 0;
SELECT id, name FROM private_keys WHERE id = 0;
EOF

# Restart Coolify
echo "Restarting Coolify..."
docker restart coolify

echo "Waiting 30 seconds for Coolify to restart..."
sleep 30

# Check status
docker ps | grep coolify

echo ""
echo "âœ… Fix complete!"
echo ""
echo "Now go to http://192.168.1.133:8001 and try 'This machine' again"
echo ""
