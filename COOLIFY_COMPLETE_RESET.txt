# ============================================
# Complete Coolify Reset and Proper Setup
# ============================================
# This will reset Coolify's server configuration
# and let it set up "This machine" properly
# ============================================

echo "ðŸ”„ Resetting Coolify server configuration..."

# Step 1: Remove all our manual database entries
echo "Cleaning database..."
docker exec -i coolify-db psql -U coolify -d coolify << 'EOF'
-- Remove SSL certificates first (foreign key constraint)
DELETE FROM ssl_certificates WHERE server_id = 0;

-- Remove the server
DELETE FROM servers WHERE id = 0;

-- Remove the private key
DELETE FROM private_keys WHERE id = 0;

-- Verify they're gone
SELECT COUNT(*) as server_count FROM servers;
SELECT COUNT(*) as key_count FROM private_keys;
EOF

# Step 2: Make sure SSH is properly set up on the host
echo ""
echo "Setting up SSH on host..."
mkdir -p /root/.ssh
chmod 700 /root/.ssh

# Generate a fresh key if needed
if [ ! -f /root/.ssh/id_ed25519 ]; then
    ssh-keygen -t ed25519 -f /root/.ssh/id_ed25519 -N "" -C "coolify-auto"
fi

# Add to authorized_keys
cat /root/.ssh/id_ed25519.pub >> /root/.ssh/authorized_keys
chmod 600 /root/.ssh/authorized_keys

# Step 3: Test SSH to localhost works
echo ""
echo "Testing SSH to localhost..."
ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@localhost "echo 'SSH works'" 2>&1

# Step 4: Restart Coolify completely
echo ""
echo "Restarting Coolify..."
docker restart coolify

echo "Waiting 40 seconds for full restart..."
sleep 40

# Step 5: Check the logs
echo ""
echo "Checking startup logs..."
docker logs coolify --tail 30 | grep -i "seeder\|payload\|error"

echo ""
echo "âœ… Reset complete!"
echo ""
echo "Now try these steps:"
echo "1. Go to http://192.168.1.133:8001"
echo "2. Refresh the page (Ctrl+Shift+R or Cmd+Shift+R)"
echo "3. Try clicking 'This machine' again"
echo ""
echo "If it still doesn't work, we'll add the server manually instead."
